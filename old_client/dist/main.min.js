angular.module("jam",["jam.song","jam.songs","jam.profile","jam.auth","jam.upload","jam.groups","jam.groupSettings","jam.playlist","jam.player","jam.usersFactory","jam.groupsFactory","jam.uploadsFactory","jam.songsFactory","ngRoute","ngAnimate","ngFileUpload","ngImgCrop","ngProgress","dndLists","focus-if"]).config(["$routeProvider","$httpProvider",function(e,t){e.when("/login/",{templateUrl:"app/auth/login.html",controller:"AuthController"}).when("/login/:email",{templateUrl:"app/auth/login.html",controller:"AuthController"}).when("/song/:id",{templateUrl:"app/song/song.html",controller:"SongController",controllerAs:"songCtrl",authenticate:!0}).when("/songs",{templateUrl:"app/songs/songs.html",controller:"SongsController",controllerAs:"songCtrl",authenticate:!0}).when("/profile",{templateUrl:"app/profile/profile.html",controller:"ProfileController",authenticate:!0}).when("/upload",{templateUrl:"app/upload/upload.html",controller:"UploadController",authenticate:!0}).when("/groups",{templateUrl:"app/groups/groups.html",controller:"GroupsController",authenticate:!0}).when("/group/settings",{templateUrl:"app/groups/settings.html",controller:"SettingsController",authenticate:!0}).when("/playlists",{templateUrl:"app/playlist/playlist.html",controller:"PlaylistController",controllerAs:"playlistCtrl",authenticate:!0}).otherwise({redirectTo:"/songs"}),t.interceptors.push("AttachTokens")}]).directive("navBar",function(){return{restrict:"E",templateUrl:"app/nav/nav.html",scope:{},controller:["$scope","Users","$window",function(e,t,n){e.logout=function(){t.logout(),n.location.reload()},e.user={},e.showMenu=!1,e.toggleMenu=function(){e.showMenu=!e.showMenu},t.getUserData().then(function(n){return e.user=n,t.getGroups(n.id)}).then(function(t){e.user.invites=t.pending})["catch"](console.error)}]}}).directive("groupsNav",function(){return{restrict:"E",templateUrl:"app/nav/groupsNav.html",scope:{},controller:["$scope","Users",function(e,t){}]}}).directive("songView",function(){return{restrict:"E",templateUrl:"app/songs/songView.html",scope:{song:"=",index:"="},controller:["$scope","$sce","$route","$location","Songs",function(e,t,n,o,r){e.editTitle=!1,e.arrowBack=!1,o.path().match(/^\/song\/.*/)?(e.songUrl="/#"+o.search().from,e.arrowBack=!0):e.songUrl="/#/song/"+e.song.id+"?from="+o.path(),e.$on("audioPlayerEvent",function(t,n){e.setIsPlaying()}),e.updateSong=function(){r.updateSong(e.song).then(function(t){_.extend(e.song,t)})},e.setIsPlaying=function(){var t=r.getCurrentSong(),n=r.getViewLocation()||"songs";t&&t.id===e.song.id&&n===t.location&&!r.getPlayer().paused?e.isPlaying=!0:e.isPlaying=!1},e.setIsPlaying()}]}}).directive("player",function(){return{restrict:"E",templateUrl:"app/player/player.html"}}).directive("modalDialog",function(){return{restrict:"E",templateUrl:"app/modal/modal.html",scope:{show:"="},replace:!0,transclude:!0,link:function(e,t,n){e.dialogStyle={},n.width&&(e.dialogStyle.width=n.width),n.height&&(e.dialogStyle.height=n.height),e.hideModal=function(){e.show=!1}}}}).directive("myEnter",function(){return function(e,t,n){t.bind("keydown keypress",function(t){13===t.which&&(e.$apply(function(){e.$eval(n.myEnter)}),t.preventDefault())})}}).factory("AttachTokens",["$window",function(e){var t={request:function(t){if(!t.url.match(/^\/api\/.*/))return t;var n=e.localStorage.getItem("com.jam");return n&&(t.headers["x-access-token"]=n),t.headers["Allow-Control-Allow-Origin"]="*",t}};return t}]).run(["$rootScope","$location","Users",function(e,t,n){e.$on("$routeChangeStart",function(e,o,r){o.$$route&&o.$$route.authenticate&&!n.isAuth()&&t.path("/login")})}]),angular.module("jam.auth",[]).controller("AuthController",["$scope","$window","$location","$routeParams","Users",function(e,t,n,o,r){e.confirm=!1,e.passMismatch=!1,e.loginError="",e.signupError="",e.user={},e.user.email=o.email||"",e.toggleLogin=function(){e.user.email=e.user.password="",e.loginForm.$setPristine(),e.showLogin=!e.showLogin,e.showSignup&&e.showLogin&&(e.showSignup=!1)},e.toggleSignup=function(){e.user.email=e.user.password="",e.signupForm.$setPristine(),e.showSignup=!e.showSignup,e.showSignup&&e.showLogin&&(e.showLogin=!1)},e.login=function(){e.loginError="",r.login(e.user).then(function(e){n.path("/songs")})["catch"](function(t){console.error(t.data),e.loginError=t.data})},e.signup=function(t){e.signupError="",t===e.user.password?(e.passMismatch=!1,e.user.displayName="anonymous",r.signup(e.user).then(function(e){n.path("/profile")})["catch"](function(t){console.error(t.data),e.signupError=t.data})):(e.newPassword="",e.passMismatch=!0,e.user.password="")},e.logout=function(){r.logout(),e.user=null},e.images=["evergreen1.jpg","evergreen2.jpg","evergreen3.jpg","evergreen4.jpg","safety1.JPG","safety2.JPG","safety3.JPG","safety4.JPG","safety5.JPG"],e.backImage={"background-image":"url(assets/bands/"+e.images[Math.floor(Math.random()*e.images.length)]+")"}}]),angular.module("jam.groups",[]).controller("GroupsController",["$scope","$route","Users","Groups","Songs",function(e,t,n,o,r){e.user={},e.newGroup={},e.data={},e.chooseRole={role:"admin"},e.playable=r.getPlayable(),e.invitees=[],e.toggleCreateModal=function(){e.createModalShown=!e.createModalShown},e.memberInfo=function(t,n){e.clickedMember=t,e.clickedMember.isAdmin="admin"===t.userGroups.role,e.clickedMember.index=n,e.chooseRole.role=t.userGroups.role,e.memberModalShown=!0},e.updateRole=function(t){e.chooseRole.role!==e.clickedMember.role&&o.updateUserRole(e.user.currentGroupId,t,e.chooseRole.role).then(function(){e.data.members[e.clickedMember.index].userGroups.role=e.chooseRole.role,e.memberModalShown=!1})["catch"](console.error)},e.removeMember=function(t){o.removeUser(e.user.currentGroupId,t).then(function(){e.data.members.splice(e.clickedMember.index,1),e.memberModalShown=!1})["catch"](console.error)},e.acceptInvite=function(t,n){o.updateUserRole(t.id,e.user.id,"member").then(function(){t.userGroups.role="member",_.each(t.users,function(t){e.user.id===t.id&&(t.userGroups.role="member")}),e.data.groups.push(t),e.data.pendingGroups.splice(n,1)})["catch"](console.error)},e.rejectInvite=function(t,n){o.removeUser(t.id,e.user.id).then(function(t){e.data.pendingGroups.splice(n,1)})["catch"](console.error)},e.createGroup=function(){o.createGroup(e.newGroup).then(function(t){o.addUser(t.id,e.user.id,"admin").then(function(n){e.createModalShown=!1,e.refreshGroups(n,!0),e.sendInvites(t)})})},e.sendInvites=function(t){_.each(e.invitees,function(e){o.sendInvite(t,e).then(function(t){console.log(e+" invited! ")})["catch"](console.error)})},e.setCurrentGroup=function(t){n.updateProfile({currentGroupId:t.id}).then(function(n){e.user=n.data.user,e.user.currentGroup=t,e.user.isAdmin="admin"===e.user.currentGroup.userGroups.role,e.data.members=e.user.currentGroup.users,r.resetPlayer()})["catch"](function(e){console.error(e)})},e.updateProfile=function(){return n.updateProfile(e.user).then(function(e){})["catch"](function(e){console.error(e)})},e.isNotCurrentGroup=function(t){return t.id!==e.user.currentGroup.id},e.refreshGroups=function(t,n){o.getGroupsData(t,n).then(function(t){e.data.groups=[],e.data.pendingGroups=[],_.each(t,function(t){t.id===e.user.currentGroupId&&(e.user.currentGroup=t,e.user.isAdmin="admin"===e.user.currentGroup.userGroups.role,e.data.members=e.user.currentGroup.users),"pending"===t.userGroups.role?e.data.pendingGroups.push(t):e.data.groups.push(t)})})},e.deleteGroup=function(e){o.deleteGroup(e).then(function(e){console.log(e)})["catch"](console.error)},n.getUserData().then(function(t){e.user=t,e.refreshGroups(t)})["catch"](console.error)}]),angular.module("jam.groupSettings",[]).controller("SettingsController",["$scope","$timeout","Upload","Users","Groups","UploadFactory","Songs",function(e,t,n,o,r,a,u){e.user={},e.group={},e.sendingInvite=!1,e.playable=u.getPlayable(),e.inviteError="",o.getUserData().then(function(t){e.user=t,e.group=t.currentGroup})["catch"](console.error),e.showBannerModal=function(t){e.file=t,e.bannerModalShown=!0},e.hideBannerModal=function(){e.bannerModalShown=!1},e.sendInvite=function(){e.inviteError="",e.sendingInvite=!0,r.sendInvite(e.group,e.invite).then(function(t){e.invite="",e.inviteForm.$setPristine(),r.getGroupsData(e.user,!0).then(function(){e.sendingInvite=!1})["catch"](console.error)})["catch"](function(t){e.inviteError=t.data,e.sendingInvite=!1,console.error(t)})},e.updateGroupProfile=function(n){n&&(e.updatingName=!0,t(function(){e.updatingName=!1},300)),r.updateInfo(e.group).then(function(t){_.extend(e.user.currentGroup,t)})["catch"](console.error)},e.removeBanner=function(){r.updateInfo({id:e.group.id,bannerUrl:""}).then(function(t){_.extend(e.user.currentGroup,t.data)})["catch"](console.error)};var l=function(e,t){e.progress=Math.min(100,parseInt(100*t.loaded/t.total))},i=function(t){e.errorMsg=t.status+": "+t.data},s=function(t,n){e.result=n.data,e.group.bannerUrl=t.s3url,e.hideBannerModal(),e.updateGroupProfile()};e.upload=function(t,o){var r=n.dataUrltoBlob(t,o);e.file=r,r&&a.upload(r,"images",s,i,l)}}]),angular.module("jam.player",[]).controller("PlayerController",["$scope","$rootScope","$timeout","Songs",function(e,t,n,o){e.isTouchDevice="ontouchstart"in document.documentElement,e.audio=o.getPlayer(),e.song=o.getCurrentSong(),e.playlist=o.getSoundsAndIndex(),e.muted=o.getMuted(),e.timeFormat="00:00",e.playable=o.getPlayable(),e.timeSliderDisabled=!e.playable||e.isTouchDevice,e.snapVol=function(){e.audio.volume<.05&&e.mute()},e.speeds=[.5,.8,1,1.5,2],setInterval(function(){e.$apply()},200),e.showSpeed=!1,e.$watch(function(e){return e.audio.volume},function(t,n){t&&e.muted&&(o.setMuted(!1),e.muted=!1)}),e.$watch(function(e){return e.audio.currentTime},function(t,n){e.timeFormat=o.timeFormat(t)}),e.stop=function(){e.audio.pause(),e.audio.currentTime=0},e.mute=function(){e.muted?e.audio.volume=o.getVolume():e.audio.volume=0,e.muted=!e.muted,o.setMuted(e.muted)},e.changeTrack=function(t){var n=o.getSongIndex();"back"===t&&(0===n?(e.stop(),e.audio.play()):o.setSongIndex(n-1)),"forward"===t&&(n===e.playlist.songs.length-1?(o.resetPlayer(),e.song=o.getCurrentSong()):o.setSongIndex(n+1))},e.setSpeed=function(t){var n=e.speeds.indexOf(e.audio.playbackRate);nextIndex=n+t,nextIndex<0&&(nextIndex=0),nextIndex>=e.speeds.length&&(nextIndex=e.speeds.length-1),e.audio.playbackRate=e.speeds[nextIndex]},e.togglePlay=function(){e.audio.paused?e.audio.play():e.audio.pause(),t.$broadcast("audioPlayerEvent","TOGGLE_PLAY")};var r=function(){e.playlist=o.getSoundsAndIndex(),e.song=e.playlist.songs[e.playlist.index],e.audio.src=e.song.address||null,e.audio.onended=o.nextIndex,e.audio.ondurationchange=function(t){e.timeSliderDisabled=!e.audio.duration||e.isTouchDevice,o.setPlayable(!!e.audio.duration),e.playable=o.getPlayable()},e.audio.play()},a=function(){e.stop(),e.audio=o.getPlayer(),e.playlist=o.getSoundsAndIndex(),e.timeSliderDisabled=!e.audio.duration},u=function(){e.playlist=o.getSoundsAndIndex(),e.timeSliderDisabled=!e.audio.duration},l=function(e){t.$broadcast("audioPlayerEvent",e)};o.registerObserverCallback("CHANGE_SONG",r),o.registerObserverCallback("TOGGLE_PLAY",e.togglePlay),o.registerObserverCallback("RESET_PLAYER",a),o.registerObserverCallback("REFRESH_LIST",u),o.registerObserverCallback("ANY_AUDIO_EVENT",l)}]),angular.module("jam.playlist",[]).controller("PlaylistController",["$scope","Users","Songs","Groups",function(e,t,n,o){e.newPlaylist={},e.models={selected:null},e.models.currentPlaylist=n.getCurrentPlaylist(),e.models.playlists=[],e.user={},e.where="playlist",n.setViewLocation(e.where),e.playable=n.getPlayable(),e.updateIndex=function(t){n.choose(t,e.where,e.models.currentPlaylist)},e.dropCallback=function(t,n,o,r,a,u){return e.reorderPlaylist(e.models.selected,n),o},e.reorderPlaylist=function(t,o){var r=t.playlistSongs.listPosition;if(o>r&&o--,r!==o){var a=e.models.currentPlaylist.songs[r];e.models.currentPlaylist.songs.splice(r,1),e.models.currentPlaylist.songs.splice(o,0,a);for(var u=[],l=0,i=e.models.currentPlaylist.songs.length;i>l;l++)e.models.currentPlaylist.songs[l].playlistSongs.listPosition=l,u.push({songId:e.models.currentPlaylist.songs[l].id,listPosition:l});n.updatePlaylistPosition(e.models.currentPlaylist.id,u).then(function(e){})["catch"](console.error)}},t.getUserData().then(function(t){e.user=t,e.newPlaylist.groupId=e.user.currentGroup.id,o.getPlaylistsByGroupId(e.user.currentGroup.id).then(function(t){e.models.playlists=t,t.length&&e.makeCurrent(t[0])})})["catch"](console.error),e.toggleCreateModal=function(){e.createModalShown=!e.createModalShown},e.pendingDeletePlaylist=function(t){e.pendingPlaylist=t,e.destroyModalShown=!0},e.makeCurrent=function(t){e.models.currentPlaylist=t,n.getPlaylistSongs(t.id).then(function(t){e.models.currentPlaylist.songs=t})["catch"](console.error)},e.createPlaylist=function(){n.createPlaylist(e.newPlaylist).then(function(t){e.createModalShown=!1,o.getPlaylistsByGroupId(e.user.currentGroup.id).then(function(t){e.models.playlists=t})["catch"](console.error)})},e.deleteSong=function(t){var o=e.models.currentPlaylist.songs[t].id;e.models.currentPlaylist.songs.splice(t,1),n.deleteFromPlaylist(o,e.models.currentPlaylist.id).then(function(e){console.log(e)})["catch"](console.error)},e.deletePlaylist=function(){var t=e.pendingPlaylist;e.models.currentPlaylist.id===t.id&&(e.models.currentPlaylist={}),n.deletePlaylist(t.id).then(function(n){e.destroyModalShown=!1,e.models.playlists=_.filter(e.models.playlists,function(e){return e.id!==t.id})})["catch"](console.error)}}]),angular.module("jam.profile",[]).controller("ProfileController",["$scope","$location","$window","$timeout","Users","Upload","UploadFactory","Songs",function(e,t,n,o,r,a,u,l){e.avatarURL="",e.playable=l.getPlayable(),r.getUserData().then(function(t){e.user=t})["catch"](console.error),e.showAvatarModal=function(t){e.file=t,e.avatarModalShown=!0},e.hideAvatarModal=function(){e.avatarModalShown=!1};var i=function(e,t){e.progressPercentage=Math.min(100,parseInt(100*t.loaded/t.total))},s=function(t){e.errorMsg=t.status+": "+t.data},c=function(t,n){t.result=n.data,e.user.avatarURL=t.s3url,e.hideAvatarModal(),e.updateProfile()};e.upload=function(t,n){var o=a.dataUrltoBlob(t,n);e.file=o,o&&u.upload(o,"images",c,s,i)},e.updateProfile=function(){r.updateProfile(e.user).then(function(t){e.user=t.data.user})["catch"](function(e){console.error(e)})}}]),angular.module("jam.groupsFactory",[]).factory("Groups",["$http","$q",function(e,t){var n=null,o=function(t){return e({method:"POST",url:"/api/groups/",data:t}).then(function(e){return e.data})},r=function(t,n,o){var r={userId:n,role:o};return e({method:"POST",url:"/api/groups/"+t+"/users/",data:r}).then(function(e){return e.data})},a=function(t){return e({method:"GET",url:"/api/users/"+t+"/groups/"}).then(function(e){return _.extend(n,e.data),e.data})},u=function(t){return e({method:"GET",url:"/api/groups/"+t+"/playlists/"}).then(function(e){return e.data})},l=function(t){return e({method:"PUT",url:"/api/groups/info",data:t}).then(function(e){return e.data})["catch"](console.error)},i=function(t,n){var o={email:n,group:t};return e({method:"post",url:"/api/groups/"+t.id+"/invite",data:o}).then(function(e){return e.data})},s=function(t,n,o){var r={role:o};return e({method:"PUT",url:"/api/groups/"+t+"/users/"+n,data:r}).then(function(e){return e.data})},c=function(t,n){return e({method:"DELETE",url:"/api/groups/"+t+"/users/"+n}).then(function(e){return e.data})},d=function(e,o){return o=o||!1,t(function(t,r){n&&!o&&t(n),a(e.id).then(function(e){n?_.extend(n,e):n=e,t(n)})["catch"](function(e){r(e)})})},g=function(e){e?_.extend(n,e):n=null},p=function(t){return e({method:"DELETE",url:"/api/groups/"+t}).then(function(e){return e.data})};return{createGroup:o,addUser:r,getGroupsByUserId:a,getPlaylistsByGroupId:u,updateInfo:l,sendInvite:i,updateUserRole:s,removeUser:c,getGroupsData:d,setGroupsData:g,deleteGroup:p}}]),angular.module("jam.songsFactory",[]).factory("Songs",["$http","$q",function(e,t){var n=new Audio,o={songs:[],playlist:[]},r=null,a="songs",u=0,l=!1,i=!1,s=null,c={},d=function(n,o){var r={size:n.size,lastModified:n.lastModified,name:n.displayName||n.name,uniqueHash:n.uniqueFilename,address:n.s3url,duration:n.duration};return t(function(t,n){e({method:"POST",url:"/api/groups/"+o+"/songs/",data:r}).then(function(e){t(e)})["catch"](function(e){n(e)})})},g=function(t){return e({method:"GET",url:"/api/groups/"+t+"/songs/"}).then(function(e){return o.songs=e.data,e.data})},p=function(t){return e({method:"GET",url:"/api/songs/"+t}).then(function(e){return e.data})},m=function(t){return e({method:"PUT",url:"/api/songs/"+t.id,data:t}).then(function(e){return e.data})},f=function(t){return e({method:"DELETE",url:"/api/songs/"+t.id}).then(function(e){return e.data})},h=function(t,n){return e({method:"POST",url:"/api/songs/"+n+"/comments/",data:t}).then(function(e){return e.data})},y=function(t){return e({method:"GET",url:"/api/songs/"+t+"/comments/"}).then(function(e){return e.data})},P=function(t){return e({method:"DELETE",url:"/api/tags/"+t.id}).then(function(e){return e.data})},S=function(t){return e({method:"POST",url:"/api/playlists/",data:t}).then(function(e){return e.data})},v=function(t,n,o){var r={index:o};return e({method:"POST",url:"/api/playlists/"+t+"/"+n+"/",data:r}).then(function(e){return e.data})},w=function(t){return e({method:"GET",url:"/api/playlists/"+t+"/"}).then(function(e){return o.playlist=e.data,e.data})["catch"](console.error)},G=function(t,n){return e({method:"PUT",url:"/api/playlists/"+t,data:n})},x=function(t,n){return e({method:"DELETE",url:"/api/playlists/"+t+"/"+n+"/"}).then(function(e){return e.data})},b=function(t){return e({method:"DELETE",url:"/api/playlists/"+t+"/"}).then(function(e){return e.data})},E=function(e,n){var r=t(function(e,t){o.songs.length<=0?g(n).then(function(){e(!0)})["catch"](t):e(!0)});return r.then(function(){var t=_.findIndex(o.songs,function(t){return e===t.id});return $(t,"songs"),o.songs[t]})},I={},U=function(e,t){I[e]=t},C=function(e){I[e](),I.ANY_AUDIO_EVENT(e)},M=function(){return{songs:o[a],index:r,location:a}},A=function(){r<o[a].length-1?(r++,C("CHANGE_SONG")):C("RESET_PLAYER")},T=function(){C("TOGGLE_PLAY")},$=function(e,t,n){r===+e&&a===t?C("TOGGLE_PLAY"):(r=e,a=t,c="playlist"===t?n:{},C("CHANGE_SONG"),i=!0)},L=function(e,t){t===a&&(o[a][r]&&o[a][r].id===e?(n=new Audio,o[a].splice(r,1),r=null,i=!1,C("RESET_PLAYER")):(o[a]=_.filter(o[a],function(t){return t.id!==e}),C("REFRESH_LIST")))},D=function(e){r=e,C("CHANGE_SONG")},j=function(e){return r},R=function(e){u=e},k=function(){return u},F=function(e){l=e},O=function(){return l},q=function(){return n},N=function(e){e=e},B=function(){return i},Y=function(){var e=null!==r?o[a][r]:null;return e?(e.location=a,e):null},V=function(){return c},H=function(e){s=e},z=function(){return s},J=function(e){var t=Math.floor(e%60),n=Math.floor(e%3600/60),o=Math.floor(e/3600),r=o?o+":":"";return r+=String("00"+n).slice(-2)+":"+String("00"+t).slice(-2)},Q=function(){r=null,i=!1,n=new Audio,C("RESET_PLAYER")};return{addComment:h,addSong:d,getComments:y,deleteComment:P,deleteSong:f,getAllSongs:g,getSong:p,updateSong:m,createPlaylist:S,addSongToPlaylist:v,getPlaylistSongs:w,updatePlaylistPosition:G,deleteFromPlaylist:x,deletePlaylist:b,getSoundsAndIndex:M,nextIndex:A,choose:$,getPlayer:q,checkReset:L,resetPlayer:Q,setSongIndex:D,getSongIndex:j,setVolume:R,getVolume:k,setMuted:F,getMuted:O,togglePlay:T,setPlayable:N,getPlayable:B,getCurrentSong:Y,getCurrentPlaylist:V,playFromAllSongs:E,setViewLocation:H,getViewLocation:z,registerObserverCallback:U,timeFormat:J}}]),angular.module("jam.uploadsFactory",["jam.usersFactory"]).factory("UploadFactory",["$http","$window","$q","Upload","Users","Songs",function(e,t,n,o,r,a){var u=[],l=function(t,n,a,u,l){var i={uniqueFilename:t.name,fileType:t.type};e.post("/api/s3",i).then(function(e){var n=e.data;s(n,t)},function(e){console.log("Error",e)}),String.prototype.uuid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0,n="x"===e?t:3&t|8;return n.toString(16)})};var s=function(e,t){console.log("Begin s3 upload",e);r.getUserData().then(function(r){var i=t.name.replace(/^.*\./,""),s=(Date.now()+t.name).uuid()+"."+i,c={key:n+"/"+s,acl:"public-read","Content-Type":t.type,AWSAccessKeyId:e.AWSAccessKeyId,success_action_status:"201",Policy:e.s3Policy,Signature:e.s3Signature};t.status="UPLOADING",t.progressPercentage=0,t.uploader=o.upload({url:"https://"+e.bucketName+".s3.amazonaws.com/",method:"POST",transformRequest:function(e,t){var n=t();return delete n.Authorization,e},data:c,file:t}),t.uploader.then(function(e){if(t.status="COMPLETE",t.progressPercentage=parseInt(100),console.log("Upload confirmed"),201===e.status){var n=(new DOMParser).parseFromString(e.data,"application/xml").getElementsByTagName("Location")[0].textContent;t.s3url=unescape(n),t.uniqueFilename=s,a&&a(t,e)}else t.status="ERROR",u&&u(e)},null,function(e){l&&l(t,e)}),t.uploader["catch"](u)})}};return{upload:l,audioQueue:u}}]),angular.module("jam.usersFactory",[]).factory("Users",["$http","$location","$window","$q","Groups",function(e,t,n,o,r){var a=null,u=function(t){return e({method:"POST",url:"/api/users/login",data:t}).then(function(e){return a=e.data.user,n.localStorage.setItem("com.jam",e.data.token),e.data})},l=function(t){return e({method:"POST",url:"/api/users/signup",data:t}).then(function(e){return a=e.data.user,n.localStorage.setItem("com.jam",e.data.token),e.data})},i=function(t){return e({method:"GET",url:"/api/users/"+t+"/groups/"}).then(function(e){return e.data})},s=function(t){return e({method:"GET",url:"/api/users/"+t}).then(function(e){return e.data.user})},c=function(){n.localStorage.removeItem("com.jam"),a=null,r.setGroupsData(null),t.path("/login")},d=function(t){return e({method:"PUT",url:"/api/users/profile",data:t}).then(function(e){return _.extend(a,e.data.user),n.localStorage.setItem("com.jam",e.data.token),e})["catch"](console.error)},g=function(t){return e({method:"GET",url:"/api/users/profile"})},p=function(e){return e=e||!1,o(function(t,n){a&&!e&&t(a),g().then(function(e){a?_.extend(a,e.data.user):a=e.data.user,t(a)})["catch"](function(e){n(e)})})},m=function(){return!!n.localStorage.getItem("com.jam")};return{updateProfile:d,getGroups:i,getProfile:g,login:u,signup:l,getUser:s,isAuth:m,logout:c,getUserData:p}}]),angular.module("jam.song",[]).controller("SongController",["$scope","$location","$route","Songs","Users",function(e,t,n,o,r){e.song={},e.audio=o.getPlayer(),e.commentTime=null,e.pinningComment=!1,e.user={},e.comments=[],e.selectedComment=[{}],e.songInPlayer=!1,e.alreadyPlaying=!1,e.playable=o.getPlayable(),e.fromUrl="/#"+t.search().from;var a,u=document.getElementsByClassName("page-content")[0].offsetWidth,l=100,i=.9*u,s=2,c=12,d=20,g=1,p=2e3;e.width=i+"px",r.getUserData().then(function(t){e.user=t}).then(function(){return o.getSong(t.path().split("/")[2])}).then(function(t){e.song=t;var n=t.amplitudeData.max,o=_.max(n),r=100/o;a=n.map(function(e){return e*r})}).then(function(){return o.getComments(e.song.id)}).then(function(t){e.comments=t,S(t),e.songInPlayer=o.getCurrentSong()&&e.song.id===o.getCurrentSong().id,e.songInPlayer&&!e.audio.paused&&e.$broadcast("audioPlayerEvent","ALREADY_PLAYING"),P()});var m=function(e,t,n){return d3.select(e).append("svg").attr("height",t).attr("width",n)},f=m(".waveform-container",l,i),h=d3.select("body").selectAll(".selected-comment"),y=(d3.select("body").selectAll(".comment-icon"),d3.select("body").selectAll(".pin-container").style("height",d+"px").style("width",i+"px")),P=function(){f.attr("class","visualizer").selectAll("rect").data(a).enter().append("rect").attr("rx",s+"px").attr("ry",s+"px").attr("x",function(e,t){return t*(i/a.length)}).attr("y",l).attr("height",0).transition().delay(function(e,t){return p*t/a.length}).attr("width",i/a.length-g).attr("y",function(e){return l-e}).attr("height",function(e){return e}).attr("fill","#999"),d3.select("body").selectAll(".comment-pin-container").style("height",2*d+"px").style("width",i+"px"),d3.select("body").selectAll(".selected-comment-container").style("height",d+"px").style("width",i+"px"),_.delay(setInterval,p,w,300)};e.addComment=function(t){var n=Math.floor(e.commentTime*e.song.duration);o.addComment({note:t,time:n,userId:e.user.id},e.song.id).then(function(t){e.comments.push(t),S(e.comments),e.pinningComment=!1,e.comment=""})},e.commentSelected=function(){return!!Object.keys(e.selectedComment[0]).length},e.formatTime=function(e){return o.timeFormat(e)},e.pinComment=function(){e.commentTime=e.audio.currentTime/e.song.duration,e.pinningComment=!0,e.selectedComment=[{}]};var S=function(){y.selectAll("div").data(e.comments).enter().append("div").style("left",function(t){var n=Math.floor(t.time/e.song.duration*i)-c/2;return n+"px"}).attr("class","pin").on("mouseover",function(t,n){e.setSelectedComment(t)})},v=function(){var t=Math.floor(e.selectedComment[0].time/e.song.duration*i),n=i/2>t;h.data(e.selectedComment).style("left",function(){return n?t+"px":t-i/2+"px"}).classed("left",n).classed("right",!n).style("width",i/2+"px").text(function(e){return e.note})},w=function(){f.selectAll("rect").data(a).transition().duration(600).attr("fill",function(t,n){return n/a.length<e.audio.currentTime/e.song.duration&&e.songInPlayer?"#99D1B2":"#999"})};e.setSelectedComment=function(t){e.selectedComment=[t],v()},e.setPlayTime=function(t){if(e.songInPlayer){var n=document.getElementsByClassName("visualizer")[0],o=n.getBoundingClientRect(),r=t.clientX-o.left;e.audio.currentTime=e.song.duration*r/i}},e.updateIndex=function(){var t=o.getCurrentSong();t&&t.id===e.song.id?o.togglePlay():o.playFromAllSongs(e.song.id,e.user.currentGroupId),e.songInPlayer=!0}}]),angular.module("jam.songs",[]).controller("SongsController",["$scope","$location","Songs","Users","Groups",function(e,t,n,o,r){e.data={},e.user={},e.time=null,e.timeFormat="00:00",e.comment={},e.message="",e.commentSong={},e.where="songs",n.setViewLocation(e.where),e.playable=n.getPlayable(),e.updateIndex=function(t){n.choose(t,e.where)},o.getUserData().then(function(t){e.user=t,e.refreshSongs(),r.getPlaylistsByGroupId(e.user.currentGroup.id).then(function(t){e.data.playlists=t})})["catch"](console.error),e.addToPlaylist=function(t){e.newSong.playlistId=t.id;var o=t.length;console.log("the playlist: ",t),n.addSongToPlaylist(e.newSong.id,t.id,o).then(function(e){console.log(e)})["catch"](console.error)},e.getTime=function(){e.time=n.getPlayer().currentTime,e.timeFormat=n.timeFormat(e.time)},e.toggleCommentModal=function(t,o){e.commentSong=t;var r=n.getCurrentSong();r&&r.id===t.id&&e.getTime(),e.commentModalShown=!e.commentModalShown},e.addComment=function(){e.comment.time=e.time,e.comment.userId=e.user.id,n.addComment(e.comment,e.commentSong.id).then(function(t){e.comment={},e.time=null,e.commentModalShown=!1,e.message="comment posted: "+t})},e.toggleAddModal=function(){e.addModalShown=!e.addModalShown},e.refreshSongs=function(){n.getAllSongs(e.user.currentGroupId).then(function(t){e.data.songs=t})["catch"](console.error)},e.makeSongPending=function(t,n){e.deleteModalShown=!0,e.pendingSong=t,e.pendingSong.index=n},e.deleteSong=function(t){var o=e.data.songs[t];n.checkReset(o.id,"songs"),n.deleteSong(o).then(function(){e.deleteModalShown=!1,e.data.songs=_.filter(e.data.songs,function(e){return e.id!==o.id})})["catch"](function(t){e.message="error: "+t})}}]),angular.module("jam.upload",[]).controller("UploadController",["$scope","Upload","UploadFactory","ngProgressFactory","Users","Songs","$http",function(e,t,n,o,r,a,u){e.progressbar=o.createInstance(),e.queue=n.audioQueue,e.playable=a.getPlayable();var l=0,i=0,s=0,c=function(){for(var t=0,n=0;n<e.queue.length;n++)e.queue[n].progressPercentage&&(t+=e.queue[n].progressPercentage);s=Math.ceil(t/l),e.progressbar.set(s),100===s&&e.progressbar.complete()},d=_.throttle(c,250);e.addToQueue=function(t){for(file in t){var n=t[file];n.queueId=Math.floor(1e7*Math.random()),n.status="READY",n.editing=!1,n.displayName=n.name,e.queue.push(n)}},e.removeFile=function(t){t>-1&&e.queue.splice(t,1)};var g=function(e,t){var n,o=document.createElement("audio");o.addEventListener("canplaythrough",function(e){var o=e.currentTarget.duration;t(o),URL.revokeObjectURL(n)}),n=URL.createObjectURL(e),o.setAttribute("src",n)},p=function(e,t){var n=parseInt(100*t.loaded/t.total);e.progressPercentage=n,d()},m=function(e,t){r.getUserData().then(function(t){g(e,function(n){return e.duration=n,a.addSong(e,t.currentGroupId)})}).then(function(e){})["catch"](console.error)};e.cancelUpload=function(e){e.uploader&&(e.uploader.abort(),e.status="CANCELLED")},e.upload=function(e){e.editing=!1,n.upload(e,"audio",m,console.error,p),e.progressPercentage=0},e.cancelAll=function(){if(e.progressbar.set(0),e.queue&&e.queue.length){l=0,i=0;for(var t=0;t<e.queue.length;t++)"UPLOADING"===e.queue[t].status&&e.cancelUpload(e.queue[t])}},e.uploadFiles=function(){if(e.progressbar.set(0),e.queue&&e.queue.length){l=e.queue.length,i=0;for(var t=0;t<e.queue.length;t++)"READY"===e.queue[t].status&&e.upload(e.queue[t])}}}]);